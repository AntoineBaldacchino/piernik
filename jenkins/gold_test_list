OUT_DIR=jenkins/goldexec/
[ ! -d $OUT_DIR ] && mkdir -p $OUT_DIR
[ ! -d $OUT_DIR ] && exit 1

parallel --load 70% --delay 5 eval "./jenkins/gold_test.sh {} > ${OUT_DIR}{/.}'_gold_stdout'" ::: ./jenkins/gold_configs/*.config

OUT_DIR=jenkins/goldexec/

for j in gold riem ; do
    case $j in
    	 ("gold") jj="gold" ;;
	 ("riem") jj="Riemann" ;;
	 (*) jj="___" ;;
    esac
    for i in ./jenkins/gold_configs/*.config ; do
    	eval $( grep PROBLEM_NAME $i )

    	LOG=${OUT_DIR}${PROBLEM_NAME}_${j}_log
	if [ -e $LOG ] ; then
           echo ${PROBLEM_NAME}_${jj}" "$( tail -n 1 $LOG | awk '{print $NF}' )
    	else
	   echo ${PROBLEM_NAME}_${jj}" "-0.1
        fi
    done |\
    	 awk '{\
		    a[$1]=$2;\
		} END {\
		    for (i in a) printf("%s,",i);\
		    print "";\
		    for (i in a) printf("%s,",a[i]);\
		    print "";\
		}' |\
     	sed 's/,$//' > ${OUT_DIR}all_${jj}.csv
done

# print the results
for i in ${OUT_DIR}*_gold_log ; do
     grep "You must make yt available somehow" $i || printf "%-50s = %s\n" "[GOLD] Total difference for ${i/_gold_log/}" $( tail -n 1 $i | awk '{print $NF}' )
done
for i in ${OUT_DIR}*_riem_log ; do
     grep "You must make yt available somehow" $i || printf "%-50s = %s\n" "[Riemann] Total difference for ${i/_riem_log/}" $( tail -n 1 $i | awk '{print $NF}' )
done

# fail if any gold dstance is not 0.
for i in ${OUT_DIR}*_gold_log ; do
    [ $( ( grep "^Total difference between" $i || echo 1 ) | awk '{print $NF}' ) == 0 ] || exit 1
done
